<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Deadstock Inventory</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <a class="brand" href="#">Deadstock</a>
      </div>
    </nav>

    <main class="container">
      <div id="root"></div>
    </main>

    <script type="text/babel">
      const { useState, useEffect } = React;

      function useAuth() {
        const [loggedIn, setLoggedIn] = useState(null);
        useEffect(() => {
          fetch('/auth/me').then(r => r.json()).then(d => setLoggedIn(!!d.loggedIn));
        }, []);
        return { loggedIn, setLoggedIn };
      }

      function LoginForm({ onLoggedIn }) {
        const [username, setUsername] = useState('admin');
        const [password, setPassword] = useState('admin123');
        const [error, setError] = useState('');

        const submit = async (e) => {
          e.preventDefault();
          setError('');
          const res = await fetch('/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });
          if (res.ok) onLoggedIn(true);
          else {
            const d = await res.json().catch(() => ({}));
            setError(d.error || 'Login failed');
          }
        };

        return (
          <form className="form" onSubmit={submit}>
            <h1>Admin Login</h1>
            {error && <div className="flash danger">{error}</div>}
            <div className="form-row">
              <label>Username</label>
              <input value={username} onChange={e => setUsername(e.target.value)} />
            </div>
            <div className="form-row">
              <label>Password</label>
              <input type="password" value={password} onChange={e => setPassword(e.target.value)} />
            </div>
            <div className="form-row">
              <button type="submit">Login</button>
            </div>
          </form>
        );
      }

      function ItemForm({ initial = {}, onSubmit, submitText='Save' }) {
        const [item, setItem] = useState({
          item_code: '', name: '', category: '', quantity: 0, location: '', date_of_procurement: '', disposal_status: 'Active', notes: '',
          ...initial,
        });
        const update = (k, v) => setItem(s => ({ ...s, [k]: v }));

        const submit = (e) => { e.preventDefault(); onSubmit(item); };

        return (
          <form className="form" onSubmit={submit}>
            <div className="form-row"><label>Code</label><input value={item.item_code} onChange={e=>update('item_code', e.target.value)} required /></div>
            <div className="form-row"><label>Name</label><input value={item.name} onChange={e=>update('name', e.target.value)} required /></div>
            <div className="form-row"><label>Category</label><input value={item.category || ''} onChange={e=>update('category', e.target.value)} /></div>
            <div className="form-row"><label>Quantity</label><input type="number" value={item.quantity} onChange={e=>update('quantity', e.target.value)} min="0" /></div>
            <div className="form-row"><label>Location</label><input value={item.location || ''} onChange={e=>update('location', e.target.value)} /></div>
            <div className="form-row"><label>Procurement Date</label><input type="date" value={item.date_of_procurement || ''} onChange={e=>update('date_of_procurement', e.target.value)} required /></div>
            <div className="form-row">
              <label>Status</label>
              <select value={item.disposal_status} onChange={e=>update('disposal_status', e.target.value)}>
                {['Active','Obsolete','ToDispose','Disposed'].map(s => <option key={s} value={s}>{s}</option>)}
              </select>
            </div>
            <div className="form-row"><label>Notes</label><textarea value={item.notes || ''} onChange={e=>update('notes', e.target.value)} /></div>
            <div className="form-row"><button type="submit">{submitText}</button></div>
          </form>
        );
      }

      function Inventory() {
        const [items, setItems] = useState([]);
        const [filters, setFilters] = useState({ q: '', category: '', location: '', status: '' });
        const [options, setOptions] = useState({ categories: [], locations: [], statuses: [] });
        const [editingId, setEditingId] = useState(null);
        const [report, setReport] = useState(null);
        const [error, setError] = useState('');

        const load = async () => {
          const qs = new URLSearchParams(Object.entries(filters).filter(([_,v])=>v));
          const res = await fetch('/api/items?' + qs.toString());
          if (!res.ok) { setError('Failed to load items'); return; }
          const data = await res.json();
          setItems(data.items);
          setOptions(data.filters);
        };

        const loadReport = async () => {
          const res = await fetch('/api/reports/aging');
          if (res.ok) setReport(await res.json());
        };

        useEffect(() => { load(); loadReport(); }, []);

        const createItem = async (payload) => {
          setError('');
          const res = await fetch('/api/items', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          if (res.ok) { await load(); await loadReport(); }
          else {
            const d = await res.json().catch(()=>({}));
            setError(d.error || 'Create failed');
          }
        };

        const updateItem = async (id, payload) => {
          const res = await fetch('/api/items/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          if (res.ok) { setEditingId(null); await load(); await loadReport(); }
          else alert('Update failed');
        };

        const deleteItem = async (id) => {
          if (!confirm('Delete item?')) return;
          const res = await fetch('/api/items/' + id, { method: 'DELETE' });
          if (res.ok) { await load(); await loadReport(); }
        };

        const logout = async () => {
          await fetch('/auth/logout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
          window.location.reload();
        };

        return (
          <div>
            <div className="actions" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <h1>Items</h1>
              <button onClick={logout}>Logout</button>
            </div>

            {error && <div className="flash danger">{error}</div>}

            <form className="filter-form" onSubmit={(e)=>{e.preventDefault(); load();}}>
              <input placeholder="Search name or code" value={filters.q} onChange={e=>setFilters(s=>({ ...s, q: e.target.value }))} />
              <select value={filters.category} onChange={e=>setFilters(s=>({ ...s, category: e.target.value }))}>
                <option value="">All Categories</option>
                {options.categories.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
              <select value={filters.location} onChange={e=>setFilters(s=>({ ...s, location: e.target.value }))}>
                <option value="">All Locations</option>
                {options.locations.map(l => <option key={l} value={l}>{l}</option>)}
              </select>
              <select value={filters.status} onChange={e=>setFilters(s=>({ ...s, status: e.target.value }))}>
                <option value="">All Statuses</option>
                {options.statuses.map(s => <option key={s} value={s}>{s}</option>)}
              </select>
              <button type="submit">Filter</button>
              <button type="button" onClick={()=>{ setFilters({ q:'', category:'', location:'', status:'' }); setTimeout(load, 0); }}>Reset</button>
            </form>

            <h2>Create Item</h2>
            <ItemForm onSubmit={createItem} submitText="Create" />

            <h2>Inventory</h2>
            <table className="table">
              <thead>
                <tr>
                  <th>Code</th><th>Name</th><th>Category</th><th>Qty</th><th>Location</th><th>Procured</th><th>Status</th><th>Age</th><th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {items.length === 0 && <tr><td colSpan="9">No items</td></tr>}
                {items.map(it => (
                  <tr key={it.id}>
                    <td>{it.item_code}</td>
                    <td>{it.name}</td>
                    <td>{it.category || '-'}</td>
                    <td>{it.quantity}</td>
                    <td>{it.location || '-'}</td>
                    <td>{it.date_of_procurement}</td>
                    <td>{it.disposal_status}</td>
                    <td>{it.age_days}</td>
                    <td>
                      <button onClick={()=>setEditingId(editingId === it.id ? null : it.id)}>{editingId === it.id ? 'Cancel' : 'Edit'}</button>
                      <button onClick={()=>deleteItem(it.id)}>Delete</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>

            {editingId && (
              <div>
                <h2>Edit Item</h2>
                <ItemForm
                  initial={items.find(i => i.id === editingId)}
                  onSubmit={(payload)=>updateItem(editingId, payload)}
                  submitText="Update"
                />
              </div>
            )}

            <h2>Stock Aging Report</h2>
            {report && (
              <table className="table">
                <thead><tr><th>Bucket</th><th>Count</th><th>Total Qty</th></tr></thead>
                <tbody>
                  {Object.entries(report.summary).map(([label, v]) => (
                    <tr key={label}><td>{label}</td><td>{v.count}</td><td>{v.quantity}</td></tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        );
      }

      function App() {
        const { loggedIn, setLoggedIn } = useAuth();
        if (loggedIn === null) return <div>Loading...</div>;
        if (!loggedIn) return <LoginForm onLoggedIn={() => setLoggedIn(true)} />;
        return <Inventory />;
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
